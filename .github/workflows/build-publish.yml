name: Build and Publish

on:
  push:
    branches: [main, develop]
    tags: ["v*"]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.12"

jobs:
  build:
    name: Build Package
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # fetch full history and tags for versioning

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: false # Disable cache to prevent warnings
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Determine and set next version (Conventional Commits)
        id: get-version
        shell: bash
        run: |
          set -euo pipefail

          # Helper: read version from pyproject.toml
          read_py_version() {
            python -c "import tomllib;print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])"
          }

          # Find latest tag matching v* (semantic version)
          LAST_TAG=$(git describe --tags --match "v[0-9]*" --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            BASE_VERSION="${LAST_TAG#v}"
            RANGE="$LAST_TAG..HEAD"
          else
            BASE_VERSION=$(read_py_version)
            RANGE="HEAD"
          fi
          echo "Base version: $BASE_VERSION"

          # Gather commit messages since last tag (or all)
          COMMITS=$(git log $RANGE --pretty=format:"%s%n%b" || echo "")

          # Determine bump level using Conventional Commits
          BUMP="patch"
          if echo "$COMMITS" | grep -qiE 'BREAKING CHANGE|feat!|refactor!|perf!'; then
            BUMP="major"
          elif echo "$COMMITS" | grep -qiE '(^|[[:space:]])feat(\(|:)|^feat(\(|:)|\nfeat(\(|:)'; then
            BUMP="minor"
          elif echo "$COMMITS" | grep -qiE '(^|[[:space:]])fix(\(|:)|^fix(\(|:)|\nfix(\(|:)'; then
            BUMP="patch"
          else
            BUMP="patch"
          fi
          echo "Bump level: $BUMP"

          # Parse version parts (default to 0 if missing)
          IFS='.' read -r major minor patch <<< "$BASE_VERSION"
          major=${major:-0}; minor=${minor:-0}; patch=${patch:-0}

          # Compute next version
          if [ "$BUMP" = "major" ]; then
            major=$((major+1)); minor=0; patch=0
          elif [ "$BUMP" = "minor" ]; then
            minor=$((minor+1)); patch=0
          else
            patch=$((patch+1))
          fi
          NEW_VERSION="${major}.${minor}.${patch}"

          echo "Computed next version: $NEW_VERSION"

          # If version already changed in this commit, skip auto-bump and use it as-is
          PREV_PY=$(git show HEAD~1:pyproject.toml 2>/dev/null || true)
          if [ -n "$PREV_PY" ]; then
            PREV_VER=$(echo "$PREV_PY" | python -c "import sys, tomllib; print(tomllib.loads(sys.stdin.read())['project']['version'])" 2>/dev/null || true)
          else
            PREV_VER=""
          fi
          CUR_VER=$(read_py_version)
          if [ -n "$PREV_VER" ] && [ "$PREV_VER" != "$CUR_VER" ]; then
            echo "Detected manual version bump in current commit: $CUR_VER (previous: $PREV_VER). Skipping auto-bump."
            echo "version=$CUR_VER" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Update pyproject.toml in-place
          CURRENT_VERSION=$(read_py_version)
          sed -i "s/version = \"$CURRENT_VERSION\"/version = \"$NEW_VERSION\"/" pyproject.toml

          # Verify
          UPDATED_VERSION=$(read_py_version)
          echo "Verified updated version: $UPDATED_VERSION"

          # Expose for downstream steps/jobs
          echo "version=$UPDATED_VERSION" >> $GITHUB_OUTPUT

      - name: Build package
        run: |
          # Clean previous builds
          rm -rf dist/
          # Build wheel only
          uv build --wheel --out-dir dist

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ steps.get-version.outputs.version }}
          path: dist/
          retention-days: 7

  # publish-test job removed - only using production PyPI

  publish-prod:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main') }}
    environment:
      name: ${{ 'pypi' }}
      url: https://pypi.org/project/mysingle/
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-${{ needs.build.outputs.version }}
          path: dist/

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: false
          version: "latest"

      - name: Publish to PyPI
        run: |
          uv publish --token ${{ secrets.PYPI_TOKEN }}

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build, publish-prod]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    environment:
      name: ${{ 'pypi' }}
      url: https://pypi.org/project/mysingle/
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")

          # Generate changelog
          if [ -n "$PREV_TAG" ]; then
            CHANGELOG=$(git log $PREV_TAG..HEAD --pretty=format:"- %s" --no-merges)
          else
            CHANGELOG=$(git log --pretty=format:"- %s" --no-merges)
          fi

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "## Changes" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }}
          body: |
            ${{ steps.changelog.outputs.changelog }}

            ## Installation
            ```bash
            pip install mysingle==${{ needs.build.outputs.version }}
            ```

            ## PyPI
            https://pypi.org/project/mysingle/${{ needs.build.outputs.version }}/
          draft: false
          prerelease: false
          generate_release_notes: false
