syntax = "proto3";

package genai.strategy_builder;

import "common/error.proto";
import "common/metadata.proto";
import "google/protobuf/struct.proto";

// Strategy Builder 서비스
service StrategyBuilderService {
  // 자연어에서 전략 생성
  rpc GenerateStrategy(GenerateStrategyRequest) returns (GenerateStrategyResponse);

  // 제안서 검증 (STRUCT/STATIC 사전 검증)
  rpc ValidateProposal(ValidateProposalRequest) returns (ValidateProposalResponse);

  // 템플릿 기반 전략 커스터마이징
  rpc CustomizeTemplate(CustomizeTemplateRequest) returns (CustomizeTemplateResponse);
}

// 전략 생성 요청
message GenerateStrategyRequest {
  // 자연어 의도 (필수)
  string natural_language = 1;
  // 컨텍스트 정보 (선택)
  StrategyContext context = 2;
  // 기존 템플릿 ID (선택)
  string template_id = 3;
  // 캐시 사용 여부 (기본: true)
  bool use_cache = 4;
  // 요청 메타데이터
  common.Metadata metadata = 5;
}

// 전략 컨텍스트
message StrategyContext {
  // 종목 유니버스 (예: ["AAPL", "MSFT"])
  repeated string universe = 1;
  // 시장 타입 (예: "us_stocks", "crypto")
  string market_type = 2;
  // 시간 간격 (예: "1d", "15m")
  string interval = 3;
  // 리스크 레벨 (예: "low", "medium", "high")
  string risk_level = 4;
}

// 전략 생성 응답
message GenerateStrategyResponse {
  // StrategyIR (JSON 형태)
  google.protobuf.Struct strategy_ir = 1;
  // 사전 검증 결과
  ValidationPreview validation_preview = 2;
  // 전략 설명
  string explanation = 3;
  // 신뢰도
  common.ConfidenceScore confidence = 4;
  // 제안서 ID (승인용)
  string proposal_id = 5;
  // 승인 필요 여부
  bool approval_required = 6;
}

// 검증 미리보기
message ValidationPreview {
  // STRUCT 경고
  repeated common.ValidationWarning struct_warnings = 1;
  // STATIC 경고
  repeated common.ValidationWarning static_warnings = 2;
  // 검증 통과 여부
  bool is_valid = 3;
}

// 제안서 검증 요청
message ValidateProposalRequest {
  // 제안서 ID
  string proposal_id = 1;
  // 요청 메타데이터
  common.Metadata metadata = 2;
}

// 제안서 검증 응답
message ValidateProposalResponse {
  // 검증 통과 여부
  bool is_valid = 1;
  // 경고 목록
  repeated common.ValidationWarning warnings = 2;
  // StrategyIR (재검증 결과)
  google.protobuf.Struct strategy_ir = 3;
}

// 템플릿 커스터마이징 요청
message CustomizeTemplateRequest {
  // 템플릿 ID
  string template_id = 1;
  // 커스터마이징 의도 (예: "암호화폐 시장에 최적화")
  string customization_intent = 2;
  // 컨텍스트 정보
  StrategyContext context = 3;
  // 요청 메타데이터
  common.Metadata metadata = 4;
}

// 템플릿 커스터마이징 응답
message CustomizeTemplateResponse {
  // 권장 파라미터
  map<string, google.protobuf.Value> recommended_parameters = 1;
  // 근거 설명
  string rationale = 2;
  // 신뢰도
  common.ConfidenceScore confidence = 3;
  // 커스터마이징된 StrategyIR
  google.protobuf.Struct strategy_ir = 4;
}
