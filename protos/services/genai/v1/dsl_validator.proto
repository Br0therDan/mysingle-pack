syntax = "proto3";

package genai.dsl_validator;

import "common/error.proto";
import "common/metadata.proto";

// DSL Validator 서비스
service DSLValidatorService {
  // DSL 코드 검증
  rpc ValidateDSL(ValidateDSLRequest) returns (ValidateDSLResponse);

  // DSL 자동 완성 제안
  rpc AutocompleteDSL(AutocompleteDSLRequest) returns (AutocompleteDSLResponse);

  // DSL 문법 도움말
  rpc GetSyntaxHelp(GetSyntaxHelpRequest) returns (GetSyntaxHelpResponse);

  // LLM 기반 코드 리팩토링 제안
  rpc SuggestRefactoring(SuggestRefactoringRequest) returns (SuggestRefactoringResponse);

  // LLM 기반 에러 설명 및 수정 제안
  rpc ExplainError(ExplainErrorRequest) returns (ExplainErrorResponse);

  // LLM 기반 전략 문서화 생성
  rpc GenerateDocumentation(GenerateDocumentationRequest) returns (GenerateDocumentationResponse);
}

// DSL 검증 요청
message ValidateDSLRequest {
  // DSL 코드
  string dsl_code = 1;
  // 검증 타입
  ValidationType validation_type = 2;
  // 요청 메타데이터
  common.Metadata metadata = 3;
}

// 검증 타입
enum ValidationType {
  // Represents validation type unspecified.
  VALIDATION_TYPE_UNSPECIFIED = 0;
  // 문법 검증
  VALIDATION_TYPE_SYNTAX = 1;
  // 의미 검증
  VALIDATION_TYPE_SEMANTIC = 2;
  // 전체 검증
  VALIDATION_TYPE_FULL = 3;
}

// DSL 검증 응답
message ValidateDSLResponse {
  // 검증 통과 여부
  bool is_valid = 1;
  // 문법 오류
  repeated SyntaxError syntax_errors = 2;
  // 의미 경고
  repeated common.ValidationWarning semantic_warnings = 3;
  // 개선 제안
  repeated string suggestions = 4;
}

// 문법 오류
message SyntaxError {
  // 라인 번호
  int32 line = 1;
  // 컬럼 번호
  int32 column = 2;
  // 오류 메시지
  string message = 3;
  // 예상 토큰
  string expected = 4;
  // 실제 토큰
  string actual = 5;
}

// 자동 완성 요청
message AutocompleteDSLRequest {
  // 부분 DSL 코드
  string partial_dsl = 1;
  // 커서 위치
  int32 cursor_position = 2;
  // 컨텍스트
  AutocompleteContext context = 3;
  // 요청 메타데이터
  common.Metadata metadata = 4;
}

// 자동 완성 컨텍스트
message AutocompleteContext {
  // 섹션 (예: "DATA", "CONDITIONS")
  string section = 1;
  // 부모 노드 (해당 시)
  string parent_node = 2;
}

// 자동 완성 응답
message AutocompleteDSLResponse {
  // 제안 목록
  repeated AutocompleteSuggestion suggestions = 1;
}

// 자동 완성 제안
message AutocompleteSuggestion {
  // 제안 값
  string value = 1;
  // 설명
  string description = 2;
  // 제안 타입
  SuggestionType type = 3;
  // 신뢰도
  common.ConfidenceScore confidence = 4;
  // 문서 링크 (선택)
  string documentation = 5;
}

// 제안 타입
enum SuggestionType {
  // Represents suggestion type unspecified.
  SUGGESTION_TYPE_UNSPECIFIED = 0;
  // 키워드
  SUGGESTION_TYPE_KEYWORD = 1;
  // 함수
  SUGGESTION_TYPE_FUNCTION = 2;
  // 파라미터
  SUGGESTION_TYPE_PARAMETER = 3;
  // 변수
  SUGGESTION_TYPE_VARIABLE = 4;
  // 섹션
  SUGGESTION_TYPE_SECTION = 5;
}

// 문법 도움말 요청
message GetSyntaxHelpRequest {
  // 주제 (예: "RSI", "CONDITIONS")
  string topic = 1;
  // 요청 메타데이터
  common.Metadata metadata = 2;
}

// 문법 도움말 응답
message GetSyntaxHelpResponse {
  // 제목
  string title = 1;
  // 설명
  string description = 2;
  // 예제
  repeated string examples = 3;
  // 관련 주제
  repeated string related_topics = 4;
}

// 리팩토링 제안 요청
message SuggestRefactoringRequest {
  // DSL 코드
  string dsl_code = 1;
  // 리팩토링 초점 ("performance", "readability", "maintainability")
  string focus = 2;
  // 요청 메타데이터
  common.Metadata metadata = 3;
}

// 리팩토링 제안 응답
message SuggestRefactoringResponse {
  // 리팩토링 제안 목록
  repeated RefactoringSuggestion suggestions = 1;
  // LLM 기반 여부
  bool llm_powered = 2;
}

// 리팩토링 제안
message RefactoringSuggestion {
  // 제안 제목
  string title = 1;
  // 제안 설명
  string description = 2;
  // 원본 코드
  string original_code = 3;
  // 리팩토링된 코드
  string refactored_code = 4;
  // 리팩토링 이유
  string reasoning = 5;
  // 영향도 ("PERFORMANCE", "READABILITY", "MAINTAINABILITY")
  string impact = 6;
  // 신뢰도
  common.ConfidenceScore confidence = 7;
}

// 에러 설명 요청
message ExplainErrorRequest {
  // 에러 메시지
  string error_message = 1;
  // DSL 코드
  string dsl_code = 2;
  // 에러 발생 라인
  int32 error_line = 3;
  // 요청 메타데이터
  common.Metadata metadata = 4;
}

// 에러 설명 응답
message ExplainErrorResponse {
  // 에러 설명
  string explanation = 1;
  // 근본 원인
  string root_cause = 2;
  // 수정 제안 목록
  repeated FixSuggestion fix_suggestions = 3;
  // LLM 기반 여부
  bool llm_powered = 4;
}

// 수정 제안
message FixSuggestion {
  // 수정 방법 설명
  string description = 1;
  // 수정된 코드
  string corrected_code = 2;
  // 신뢰도
  common.ConfidenceScore confidence = 3;
}

// 문서화 생성 요청
message GenerateDocumentationRequest {
  // DSL 코드
  string dsl_code = 1;
  // 요청 메타데이터
  common.Metadata metadata = 2;
}

// 문서화 생성 응답
message GenerateDocumentationResponse {
  // 전략 요약
  string summary = 1;
  // 전략 목적
  string purpose = 2;
  // 로직 단계별 설명
  repeated string logic_steps = 3;
  // 사용된 지표 목록
  repeated string indicators = 4;
  // 신호 조건
  SignalConditions signals = 5;
  // LLM 기반 여부
  bool llm_powered = 6;
}

// 신호 조건
message SignalConditions {
  // 매수 조건
  repeated string buy_conditions = 1;
  // 매도 조건
  repeated string sell_conditions = 2;
}
