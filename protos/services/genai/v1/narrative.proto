syntax = "proto3";

package genai.narrative;

import "protos/common/metadata.proto";

// Narrative Report 서비스
service NarrativeService {
  // 백테스트 리포트 생성 (서버 스트리밍)
  rpc GenerateReport(GenerateReportRequest) returns (stream GenerateReportProgress);

  // 리포트 상태 조회
  rpc GetReportStatus(GetReportStatusRequest) returns (GetReportStatusResponse);

  // 전략 비교 리포트 생성
  rpc GenerateComparisonReport(GenerateComparisonReportRequest) returns (stream GenerateReportProgress);
}

// 리포트 생성 요청
message GenerateReportRequest {
  // 백테스트 ID
  string backtest_id = 1;
  // 리포트 설정
  ReportConfig config = 2;
  // 요청 메타데이터
  common.Metadata metadata = 3;
}

// 리포트 설정
message ReportConfig {
  // 출력 형식
  ReportFormat format = 1;
  // 포함할 섹션
  repeated ReportSection sections = 2;
  // 언어 (기본: "ko")
  string language = 3;
  // 상세도
  ReportDetailLevel detail_level = 4;
}

// 리포트 형식
enum ReportFormat {
  // Represents report format unspecified.
  REPORT_FORMAT_UNSPECIFIED = 0;
  // Markdown
  REPORT_FORMAT_MARKDOWN = 1;
  // HTML
  REPORT_FORMAT_HTML = 2;
  // PDF (미래 지원)
  REPORT_FORMAT_PDF = 3;
}

// 리포트 섹션
enum ReportSection {
  // Represents report section unspecified.
  REPORT_SECTION_UNSPECIFIED = 0;
  // 요약
  REPORT_SECTION_SUMMARY = 1;
  // 성과 분석
  REPORT_SECTION_PERFORMANCE = 2;
  // 리스크 분석
  REPORT_SECTION_RISK = 3;
  // 거래 내역
  REPORT_SECTION_TRADES = 4;
  // AI 인사이트
  REPORT_SECTION_INSIGHTS = 5;
  // 개선 제안
  REPORT_SECTION_RECOMMENDATIONS = 6;
}

// 상세도
enum ReportDetailLevel {
  // Represents report detail level unspecified.
  REPORT_DETAIL_LEVEL_UNSPECIFIED = 0;
  // 간략
  REPORT_DETAIL_LEVEL_BRIEF = 1;
  // 표준
  REPORT_DETAIL_LEVEL_STANDARD = 2;
  // 상세
  REPORT_DETAIL_LEVEL_DETAILED = 3;
}

// 리포트 생성 진행률 (서버 스트리밍)
message GenerateReportProgress {
  // 작업 ID
  string task_id = 1;
  // 상태
  ReportStatus status = 2;
  // 진행률 (0-100)
  int32 progress_percent = 3;
  // 현재 단계 설명
  string current_stage = 4;
  // 최종 결과 (완료 시)
  ReportResult result = 5;
}

// 리포트 상태
enum ReportStatus {
  // Represents report status unspecified.
  REPORT_STATUS_UNSPECIFIED = 0;
  // 대기 중
  REPORT_STATUS_PENDING = 1;
  // 처리 중
  REPORT_STATUS_PROCESSING = 2;
  // 완료
  REPORT_STATUS_COMPLETED = 3;
  // 실패
  REPORT_STATUS_FAILED = 4;
}

// 리포트 결과
message ReportResult {
  // 리포트 내용 (Markdown/HTML)
  string content = 1;
  // 메타데이터
  ReportMetadata metadata = 2;
  // 경고 메시지
  repeated string warnings = 3;
}

// 리포트 메타데이터
message ReportMetadata {
  // 생성 시간 (Unix timestamp)
  int64 generated_at = 1;
  // 사용 토큰 수
  int32 tokens_used = 2;
  // 생성 시간 (밀리초)
  int64 generation_time_ms = 3;
  // 사용 모델 (예: "gpt-5-nano")
  string model_used = 4;
}

// 리포트 상태 조회 요청
message GetReportStatusRequest {
  // 작업 ID
  string task_id = 1;
  // 요청 메타데이터
  common.Metadata metadata = 2;
}

// 리포트 상태 조회 응답
message GetReportStatusResponse {
  // 작업 ID
  string task_id = 1;
  // 상태
  ReportStatus status = 2;
  // 진행률
  int32 progress_percent = 3;
  // 결과 (완료 시)
  ReportResult result = 4;
  // 에러 메시지 (실패 시)
  string error_message = 5;
}

// 비교 리포트 생성 요청
message GenerateComparisonReportRequest {
  // 비교할 백테스트 ID들 (2개 이상)
  repeated string backtest_ids = 1;
  // 리포트 설정
  ReportConfig config = 2;
  // 요청 메타데이터
  common.Metadata metadata = 3;
}
