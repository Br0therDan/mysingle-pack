syntax = "proto3";

package genai.chatops;

import "google/protobuf/struct.proto";
import "protos/common/metadata.proto";
import "protos/common/pagination.proto";

// ChatOps 서비스
service ChatOpsService {
  // 세션 생성
  rpc CreateSession(CreateSessionRequest) returns (CreateSessionResponse);

  // 양방향 스트리밍 대화
  rpc ChatStream(stream ChatMessage) returns (stream ChatResponse);

  // 세션 히스토리 조회
  rpc GetSessionHistory(GetSessionHistoryRequest) returns (GetSessionHistoryResponse);

  // 세션 종료
  rpc CloseSession(CloseSessionRequest) returns (CloseSessionResponse);
}

// 세션 생성 요청
message CreateSessionRequest {
  // 사용자 ID
  string user_id = 1;
  // 세션 컨텍스트
  SessionContext context = 2;
  // 요청 메타데이터
  common.Metadata metadata = 3;
}

// 세션 컨텍스트
message SessionContext {
  // 도메인 (예: "strategy", "analysis")
  string domain = 1;
  // 관련 엔티티 ID (선택)
  string entity_id = 2;
  // 커스텀 컨텍스트
  map<string, string> custom_context = 3;
}

// 세션 생성 응답
message CreateSessionResponse {
  // 세션 ID
  string session_id = 1;
  // 생성 시간 (Unix timestamp)
  int64 created_at = 2;
}

// 대화 메시지 (클라이언트 → 서버)
message ChatMessage {
  // 세션 ID
  string session_id = 1;
  // 사용자 메시지
  string message = 2;
  // 메타데이터 (선택)
  map<string, string> metadata = 3;
}

// 대화 응답 (서버 → 클라이언트)
message ChatResponse {
  // 세션 ID
  string session_id = 1;
  // AI 응답 (Markdown)
  string response = 2;
  // 응답 타입
  ResponseType response_type = 3;
  // 사용된 도구
  repeated ToolUsage tools_used = 4;
  // 사용 토큰 수
  int32 tokens_used = 5;
  // 응답 시간 (Unix timestamp)
  int64 timestamp = 6;
}

// 응답 타입
enum ResponseType {
  // Represents response type unspecified.
  RESPONSE_TYPE_UNSPECIFIED = 0;
  // 일반 텍스트
  RESPONSE_TYPE_TEXT = 1;
  // 전략 추천
  RESPONSE_TYPE_STRATEGY_RECOMMENDATION = 2;
  // 분석 결과
  RESPONSE_TYPE_ANALYSIS = 3;
  // 에러 메시지
  RESPONSE_TYPE_ERROR = 4;
}

// 도구 사용 정보
message ToolUsage {
  // 도구 이름 (예: "MarketDataTool")
  string tool_name = 1;
  // 도구 입력
  google.protobuf.Struct input = 2;
  // 도구 출력
  google.protobuf.Struct output = 3;
  // 실행 시간 (밀리초)
  int64 execution_time_ms = 4;
}

// 세션 히스토리 조회 요청
message GetSessionHistoryRequest {
  // 세션 ID
  string session_id = 1;
  // 페이지네이션
  common.PaginationRequest pagination = 2;
  // 요청 메타데이터
  common.Metadata metadata = 3;
}

// 세션 히스토리 조회 응답
message GetSessionHistoryResponse {
  // 히스토리 항목
  repeated HistoryEntry entries = 1;
  // 페이지네이션 정보
  common.PaginationResponse pagination = 2;
}

// 히스토리 항목
message HistoryEntry {
  // 역할 ("user", "assistant", "system")
  string role = 1;
  // 내용
  string content = 2;
  // 시간 (Unix timestamp)
  int64 timestamp = 3;
  // 토큰 수
  int32 tokens = 4;
}

// 세션 종료 요청
message CloseSessionRequest {
  // 세션 ID
  string session_id = 1;
  // 요청 메타데이터
  common.Metadata metadata = 2;
}

// 세션 종료 응답
message CloseSessionResponse {
  // 성공 여부
  bool success = 1;
  // 총 사용 토큰 수
  int32 total_tokens_used = 2;
  // 총 메시지 수
  int32 total_messages = 3;
}
