syntax = "proto3";

package genai.ir_converter;

import "google/protobuf/struct.proto";
import "protos/common/error.proto";
import "protos/common/metadata.proto";

// IR Converter 서비스
service IRConverterService {
  // IR 변환 미리보기 (읽기 전용)
  rpc PreviewConversion(PreviewConversionRequest) returns (PreviewConversionResponse);

  // IR 변환 실행 (Strategy Service 전용)
  rpc ExecuteConversion(ExecuteConversionRequest) returns (ExecuteConversionResponse);

  // 변환 가능 여부 확인
  rpc CheckConvertibility(CheckConvertibilityRequest) returns (CheckConvertibilityResponse);
}

// IR 타입
enum IRType {
  // Represents ir type unspecified.
  IR_TYPE_UNSPECIFIED = 0;
  // Graph IR
  IR_TYPE_GRAPH = 1;
  // Rules IR
  IR_TYPE_RULES = 2;
  // DSL IR
  IR_TYPE_DSL = 3;
}

// 변환 미리보기 요청
message PreviewConversionRequest {
  // 소스 IR 타입
  IRType source_type = 1;
  // 타겟 IR 타입
  IRType target_type = 2;
  // 소스 IR (JSON 형태)
  google.protobuf.Struct source_ir = 3;
  // 변환 옵션
  ConversionOptions options = 4;
  // 요청 메타데이터
  common.Metadata metadata = 5;
}

// 변환 옵션
message ConversionOptions {
  // 주석 보존 여부
  bool preserve_comments = 1;
  // 최적화 여부
  bool optimize = 2;
  // 출력 검증 여부 (기본: true)
  bool validate_output = 3;
}

// 변환 미리보기 응답
message PreviewConversionResponse {
  // 변환된 타겟 IR
  google.protobuf.Struct target_ir = 1;
  // 미리보기 코드 (DSL인 경우)
  string preview_code = 2;
  // 변환 경고
  repeated common.ConversionWarning warnings = 3;
  // 역변환 가능 여부
  bool reversible = 4;
  // 변환 메타데이터
  ConversionMetadata metadata = 5;
}

// 변환 메타데이터
message ConversionMetadata {
  // 변환 시간 (밀리초)
  int64 conversion_time_ms = 1;
  // 사용 알고리즘
  string algorithm_used = 2;
  // 노드 수 (Graph IR인 경우)
  int32 nodes_count = 3;
  // 룰 수 (Rules IR인 경우)
  int32 rules_count = 4;
}

// 변환 실행 요청 (Strategy Service 전용)
message ExecuteConversionRequest {
  // 소스 IR 타입
  IRType source_type = 1;
  // 타겟 IR 타입
  IRType target_type = 2;
  // 소스 IR
  google.protobuf.Struct source_ir = 3;
  // 변환 옵션
  ConversionOptions options = 4;
  // 요청 메타데이터
  common.Metadata metadata = 5;
  // 전략 ID (로깅용)
  string strategy_id = 6;
}

// 변환 실행 응답
message ExecuteConversionResponse {
  // 변환된 타겟 IR
  google.protobuf.Struct target_ir = 1;
  // 변환 경고
  repeated common.ConversionWarning warnings = 2;
  // 성공 여부
  bool success = 3;
  // 에러 메시지 (실패 시)
  string error_message = 4;
  // 변환 메타데이터
  ConversionMetadata metadata = 5;
}

// 변환 가능 여부 확인 요청
message CheckConvertibilityRequest {
  // 소스 IR 타입
  IRType source_type = 1;
  // 타겟 IR 타입
  IRType target_type = 2;
  // 소스 IR (선택)
  google.protobuf.Struct source_ir = 3;
  // 요청 메타데이터
  common.Metadata metadata = 4;
}

// 변환 가능 여부 확인 응답
message CheckConvertibilityResponse {
  // 변환 가능 여부
  bool convertible = 1;
  // 불가 사유 (해당 시)
  string reason = 2;
  // 제약 사항
  repeated string limitations = 3;
  // 필요 기능
  repeated string required_features = 4;
}
