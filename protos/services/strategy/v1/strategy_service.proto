syntax = "proto3";

package strategy.v1;

import "google/protobuf/struct.proto";

// Strategy Service - gRPC API
// Used by Backtest Service and GenAI Service for high-performance strategy operations
service StrategyService {
  // Get a single strategy version
  rpc GetStrategyVersion(GetStrategyVersionRequest) returns (StrategyVersionResponse);

  // Get strategy version with minimal fields (optimized for Backtest Service)
  rpc GetStrategyVersionMinimal(GetStrategyVersionMinimalRequest) returns (StrategyVersionMinimalResponse);

  // Get strategy version by MongoDB ObjectId (supports legacy clients)
  rpc GetStrategyVersionById(GetStrategyVersionByIdRequest) returns (StrategyVersionResponse);

  // Batch get multiple strategy versions (streaming response)
  rpc BatchGetStrategyVersions(BatchGetStrategyVersionsRequest) returns (stream StrategyVersionResponse);

  // Health check
  rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);

  // --- New RPCs for GenAI Service ---

  // Get a single strategy template
  rpc GetStrategyTemplate(GetTemplateRequest) returns (TemplateResponse);

  // List all accessible templates (streaming)
  rpc ListStrategyTemplates(ListTemplatesRequest) returns (stream TemplateResponse);

  // Batch get multiple strategies (streaming)
  rpc BatchGetStrategies(BatchGetStrategiesRequest) returns (stream StrategyResponse);

  // List user's strategies (auto-discovery by user_id) - NEW
  rpc ListUserStrategies(ListUserStrategiesRequest) returns (stream StrategyResponse);

  // --- Phase 3: Write Operations for GenAI Service ---

  // Create a new strategy version
  rpc CreateStrategyVersion(CreateStrategyVersionRequest) returns (CreateStrategyVersionResponse);

  // Update an existing strategy version
  rpc UpdateStrategyVersion(UpdateStrategyVersionRequest) returns (UpdateStrategyVersionResponse);
}

// Request Messages

message GetStrategyVersionRequest {
  string strategy_id = 1;
  int32 seq = 2;
  string user_id = 3;
}

message GetStrategyVersionMinimalRequest {
  string strategy_id = 1;
  int32 seq = 2;
  string user_id = 3;
  repeated string fields = 4;
}

message GetStrategyVersionByIdRequest {
  string version_id = 1;
  string user_id = 2;
}

message BatchGetStrategyVersionsRequest {
  repeated StrategyVersionIdentifier versions = 1;
  string user_id = 2;
}

message StrategyVersionIdentifier {
  string strategy_id = 1;
  int32 seq = 2;
}

message HealthCheckRequest {}

message GetTemplateRequest {
  string template_id = 1;
  string user_id = 2;
}

message ListTemplatesRequest {
  string user_id = 1;
  repeated string tags = 2;
  optional string visibility = 3;
}

message BatchGetStrategiesRequest {
  repeated string strategy_ids = 1;
  string user_id = 2;
}

message ListUserStrategiesRequest {
  string user_id = 1;
  optional int32 limit = 2;
  optional int32 offset = 3;
  optional string status = 4;
  repeated string tags = 5;
}

message CreateStrategyVersionRequest {
  string user_id = 1;
  optional string strategy_id = 2;
  string dsl_code = 3;
  optional string original_source = 4;
  optional string template_id = 5;
  optional string graph_cache = 6;
  optional string rules_cache = 7;
}

message UpdateStrategyVersionRequest {
  string user_id = 1;
  string strategy_id = 2;
  int32 seq = 3;
  optional string dsl_code = 4;
  optional string graph_cache = 5;
  optional string rules_cache = 6;
  optional string state = 7;
}

// Response Messages

message StrategyVersionResponse {
  string id = 1;
  string user_id = 2;
  string strategy_id = 3;
  int32 seq = 4;
  string state = 5;
  string dsl_code = 6;
  string dsl_code_hash = 7;
  string original_source = 8;
  optional string graph_cache = 9;
  optional string rules_cache = 10;
  optional string template_id = 11;
  repeated ValidationResult validation_pipeline = 12;
  string created_at = 13;
  string updated_at = 14;
}

message ValidationResult {
  string stage = 1;
  string status = 2;
  repeated string errors = 3;
  repeated string warnings = 4;
  optional string timestamp = 5;
}

message StrategyVersionMinimalResponse {
  string strategy_id = 1;
  int32 seq = 2;
  optional string dsl_code = 3;
  optional string dsl_code_hash = 4;
  optional string state = 5;
  optional string original_source = 6;
}

message HealthCheckResponse {
  string status = 1;
  string service = 2;
  string version = 3;
}

message TemplateResponse {
  string id = 1;
  string user_id = 2;
  string name = 3;
  string description = 4;
  string visibility = 5;
  repeated string tags = 6;
  string default_dsl = 7;
  optional google.protobuf.Struct default_execution_profile = 8;
  string created_at = 9;
  string updated_at = 10;
}

message StrategyResponse {
  string id = 1;
  string user_id = 2;
  string name = 3;
  string description = 4;
  string status = 5;
  repeated string tags = 6;
  string created_at = 7;
  string updated_at = 8;
}

message CreateStrategyVersionResponse {
  StrategyVersionResponse strategy_version = 1;
  bool new_strategy_created = 2;
  string strategy_id = 3;
  int32 seq = 4;
}

message UpdateStrategyVersionResponse {
  StrategyVersionResponse strategy_version = 1;
  bool validation_triggered = 2;
}
